{% extends "base.html" %}

{% block content %}
<h1>Forecasting</h1>
<p>This is the Forecast page.</p>

<div class="row">
  <div class="col-12 mb-3">
    <div class="card">
        <div class="card-body">
          <div id="forecastResult" style="width:100%; height:400px;"></div>
        </div>
      </div>
  </div>
</div>

<div class="row">
  <div class="col-sm-6">
    <div class="card text-white bg-dark mb-3">
      <div class="card-body">
        <h5 class="card-title">Data Forecast</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
              <thead class="thead-dark">
                  <tr>
                      <th scope="col">DATE</th>
                      <th scope="col">Forecast Value</th>
                      <th scope="col">Upper Value</th>
                      <th scope="col">Lower Value</th>
                  </tr>
              </thead>
              <tbody id="forecastTableBody">
                  <!-- Data tabel akan diisi oleh JavaScript -->
              </tbody>
          </table>
      </div>
      </div>
    </div>
  </div>

  <div class="col-sm-6">
    <div class="card text-white bg-dark mb-3">
      <div class="card-body">
        <h5 class="card-title">Actual v Forecast</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
              <thead class="thead-dark">
                  <tr>
                      <th scope="col">DATE</th>
                      <th scope="col">Forecast Value</th>
                      <th scope="col">Actual Value</th>
                  </tr>
              </thead>
              <tbody id="comparisonTableBody">
                  <!-- Data tabel akan diisi oleh JavaScript -->
              </tbody>
          </table>
      </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    fetch("/api/forecast")  // Ambil data dari Flask API
        .then(response => response.json())
        .then(data => {
            let forecastTableBody = document.getElementById("forecastTableBody");
            let comparisonTableBody = document.getElementById("comparisonTableBody");

            let labels = [];
            let forecastValues = [];
            let upperValues = [];
            let lowerValues = [];
            let actualValues = [];

            // Kosongkan tabel sebelum mengisi ulang
            forecastTableBody.innerHTML = "";
            comparisonTableBody.innerHTML = "";

            data.forEach(item => {
                // Tambahkan ke tabel Forecast
                let forecastRow = `<tr>
                    <td>${item.ds}</td>
                    <td>${item.yhat.toFixed(2)}</td>
                    <td>${item.yhat_upper.toFixed(2)}</td>
                    <td>${item.yhat_lower.toFixed(2)}</td>
                </tr>`;
                forecastTableBody.innerHTML += forecastRow;

                // Tambahkan ke tabel Actual vs Forecast
                let actualValue = item.actual_value ? item.actual_value.toFixed(2) : '-';
                let actualRow = `<tr>
                    <td>${item.ds}</td>
                    <td>${item.yhat.toFixed(2)}</td>
                    <td>${actualValue}</td>
                </tr>`;
                comparisonTableBody.innerHTML += actualRow;

                // Tambahkan data untuk grafik
                labels.push(item.ds);
                forecastValues.push(item.yhat);
                upperValues.push(item.yhat_upper);
                lowerValues.push(item.yhat_lower);
                actualValues.push(item.actual_value);
            });

            // Plot chart menggunakan Plotly.js
            var trace1 = {
                x: labels,
                y: forecastValues,
                mode: 'lines',
                name: 'Forecast',
                line: { color: 'blue' }
            };

            var trace2 = {
                x: labels,
                y: upperValues,
                mode: 'lines',
                name: 'Upper Bound',
                line: { color: 'green', dash: 'dash' }
            };

            var trace3 = {
                x: labels,
                y: lowerValues,
                mode: 'lines',
                name: 'Lower Bound',
                line: { color: 'red', dash: 'dash' }
            };

            var trace4 = {
                x: labels,
                y: actualValues,
                mode: 'markers',
                name: 'Actual',
                marker: { color: 'black', size: 6 }
            };

            var layout = {
                title: 'Energy Forecast vs Actual',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Energy (GJ)' },
                plot_bgcolor: "#f8f9fa"
            };

            Plotly.newPlot('forecastResult', [trace1, trace2, trace3, trace4], layout);
        })
        .catch(error => console.error("Error fetching forecast data:", error));
});
</script>

{% endblock %}
